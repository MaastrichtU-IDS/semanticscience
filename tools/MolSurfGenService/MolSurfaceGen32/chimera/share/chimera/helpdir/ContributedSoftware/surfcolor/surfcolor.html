<!--
--- UCSF Chimera Copyright ---
Copyright (c) 2005-2009 Regents of the University of California.
All rights reserved.  This software provided pursuant to a
license agreement containing restrictions on its disclosure,
duplication and use.  This notice must be embedded in or
attached to all copies, including partial copies, of the
software or any revisions or derivations thereof.
--- UCSF Chimera Copyright ---
-->

<html>
<head>
<TITLE>Surface Color</TITLE>
</head>
<body>
<h3>Surface Color (Electrostatic Surface Coloring)<img src="surfcolicon.png"
alt="Surface Color icon"></h3>

<p>
<b>Surface Color</b> colors
<a href="../../UsersGuide/surfattrib.html#surfmodels">surface models</a>
and their <a href="../surfcapper/surfcapper.html">caps</a> by:
<ul>
<li><a href="../../UsersGuide/filetypes.html#esp">electrostatic potential</a>
(not calculated by Chimera, but read from a file created by any of
several <a href="../../UsersGuide/filetypes.html#esp">separate programs</a>;
however, see
<a href="../coulombic/coulombic.html"><b>Coulombic Surface Coloring</b></a>)
<li><a href="../../UsersGuide/filetypes.html#volume">volume data</a>
value or gradient norm
<li> distance from a point, axis, or plane
</ul>
<table border align="right" cellspacing="1" style="margin:8px 8px 8px 8px">
<tr><td align="center"><b>radial coloring</b> (by
<br>distance from a point)</td></tr>
<tr><td><img src="emd_1116_radial2.png"></td></tr>
</table>
<b>Surface Color</b> information is included in saved
<a href="../../UsersGuide/sessions.html#sesdef">sessions</a>.
</p><p>
See also:
<a href="../delphicontroller/delphicontroller.html"><b>DelPhiController</b></a>,
<a href="../render/render.html#render"><b>Render by Attribute</b></a>,
<a href="../rainbow/rainbow.html"><b>Rainbow</b></a>,
<a href="../colorzone/colorzone.html"><b>Color Zone</b></a>,
<a href="../2dlabels/2dlabels.html#colorkey"><b>Color Key</b></a>
</p><p>
Thanks to Steve Ludtke (Baylor College of Medicine)
for developing the original version of this tool,
Isosurface Colorizer (distributed with the 
<a href="http://blake.bcm.tmc.edu/eman/eman1/" target="_blank">EMAN 
package</a>).  
The Chimera implementation uses C++ code to accelerate the color calculations.
</p><p>
There are <a href="../../UsersGuide/extension.html">several ways to start</a>
<b>Surface Color</b>, a tool in the <b>Volume Data</b> category
(including from the <a href="../volumeviewer/framevolumeviewer.html"
target="_top"><b>Volume Viewer</b></a> <b>Tools</b> menu).
It is also implemented as the command
<a href="../../UsersGuide/midas/scolor.html"><b>scolor</b></a>.
</p><p>
The same tool is available as <b>Electrostatic Surface Coloring</b>
in the <b>Surface/Binding Analysis</b> category, and
simply <a href="../../UsersGuide/filetypes.html">opening</a>
an <a href="../../UsersGuide/filetypes.html#esp">electrostatic potential</a> 
file will start this tool automatically.
</p><p>
The surface of interest should first be displayed and
<a name="choosesurf">
chosen</a> from the menu next to <b>Color surface</b>.
How to display a surface depends on its type. For example, a
<a href="../../UsersGuide/representation.html#surfaces">molecular surface</a>
can be displayed with <b>Actions... Surface... show</b> or the command
<a href="../../UsersGuide/midas/surface.html"><b>surface</b></a>,
whereas a GRASP surface is displayed by 
<a href="../../UsersGuide/filetypes.html">opening</a> a GRASP surface file.
Any <a href="../surfcapper/surfcapper.html">surface cap</a>
will be treated as part of the surface for coloring purposes.
There is an <a href="#options">option</a>
to color only the cap and not the rest of the surface.
</p><p>
Surface vertices are associated with values, either
<a href="#bydist">distances</a> or values based on
<a href="#bydata">separate data</a>.
Clicking the <b>Color</b> button applies the specified
<a href="#colors">value-to-color mapping</a>.
A surface will be recolored automatically if it changes shape.
<b>Uncolor</b> reverts the <a href="#choosesurf">chosen surface</a> 
to its color in single-color mode.
Caps will revert to the same color as the surface being capped, unless the
<a href="../surfcapper/surfcapper.html"><b>Surface Capping</b></a> option to 
<a href="../surfcapper/surfcapper.html#usecolor">use a separate color</a>
is turned on.  
</p><p>
<a name="bydist">
Choices for coloring by distance:</a>
<blockquote>
<ul>
<li><b>radius</b> - distance from a point. 
The point is defined by the <b>origin</b> coordinates.  
<li> <b>cylinder radius</b> - distance from an axis.
The axis is defined by any point on the axis and a direction.
The point is defined by the <b>origin</b> coordinates.  
<a name="axisdef">
The three values in the <b>axis</b> field specify direction.
</a>
For example, (1 0 0), (0 1 0), and (0 0 1) specify directions along
the X, Y, and Z axes, respectively.  Any three values can be entered, 
however (the axis need not be parallel to the X, Y, or Z axis).
<li> <b>height</b> - topographic height, distance from a plane.
The plane is defined by any point on the plane and a vector normal
to the plane.  The point is defined by the <b>origin</b> coordinates.  
The vector is defined by the values in the <b>axis</b> field,
as described <a href="#axisdef">above</a>.
</ul>
The <b>origin</b> and <b>axis</b> are specified in the untransformed
coordinate system of the <a href="#choosesurf">chosen surface</a>, not the
viewing coordinate system.  
The <b>origin</b> coordinates can be entered directly, 
or <b>center</b> can be clicked to set the origin to the center 
of the bounding box of the <a href="#choosesurf">chosen surface</a>.
</blockquote>
<a name="bydata">
Choices for coloring by separate data:</a>
<blockquote>
<ul>
<li><b>electrostatic potential</b> 
- values from a 
<a href="../../UsersGuide/filetypes.html#esp">potential file</a> 
<li><b>volume data value</b>
- values from
<a href="../../UsersGuide/filetypes.html#volume">volume data</a> 
<li><b>volume gradient norm</b>
- how steeply 
<a href="../../UsersGuide/filetypes.html#volume">volume data</a> 
values change in space
</ul>
If the <b>potential file</b> or <b>volume file</b> has not been opened already,
click <b>browse...</b> to locate and open the file.
</blockquote>
<a name="colors"></a>
If first started as <b>Surface Color</b>, the tool initially contains five
colors in rainbow order; started as <b>Electrostatic Surface Coloring</b>, 
it contains red, white, and blue.
</p><p>
Clicking any <a href="../../UsersGuide/coloring.html#colorwell">color well</a>
allows the color to be adjusted interactively,
and the value associated with the color can be edited.  
There are <a href="#options">options</a> to set the colors and values
automatically and to control the number of wells.
If a value is blank, the corresponding color will not be used, and
at least two values must be specified.  However, if all values are
blank when <b>Color</b> is clicked, the fields will be filled in as if the
<a href="#options">option</a> to set the full range of values had been used.
</p><p>
<a name="options">Clicking the <b>Options</b> button</a> reveals 
additional settings that can be hidden again by clicking the small button
<img src ="../volumeviewer/x.png"</a> on the right.
  <ul>
  <li>The number of <b>Colors</b> can be 2, 3, 5, 10, 15, or 20.
  <li> Choosing a <b>Palette</b> populates the 
  <a href="../../UsersGuide/coloring.html#colorwell">color wells</a>
  with a set of colors:
     <ul>
     <li> <b>Rainbow</b> - standard rainbow colors, starting with red
     and ending with blue
     <li> <b>Gray</b> - grayscale, starting with black and ending with white
     <li> <b>Red-Blue</b> - from red to white to blue
     <li> <b>Cyan-Maroon</b> - from a medium cyan to white to maroon
     </ul>
  Clicking <b>Reverse</b> puts the colors in the opposite order.
  <li><b>Create color key</b> - open the
  <a href="../2dlabels/2dlabels.html#colorkey"><b>Color Key</b></a> dialog
  and populate it with the current <b>Surface Color</b> colors and values;
  a color key can then be created interactively with the mouse
  <li><b>Set full range of surface values</b> - set the color-associated values 
  to range linearly from the minimum to the maximum found in the surface
  <li><b>Surface offset</b> (for coloring by
  <a href="../../UsersGuide/filetypes.html#esp">electrostatic potential</a>
  only; default <b>1.4</b> &Aring;)
  - how far out from each surface vertex, along its normal,
  to evaluate the electrostatic potential.  The rationale for looking outward
  is that the values at the centers of any interacting atoms are more relevant
  than those at their surfaces.  A 
  <a href="../../UsersGuide/representation.html#surfaces">molecular surface</a>
  is <b><i>solvent-excluded</i></b>; it shows where the surface of a 
  spherical probe (typically of radius 1.4 &Aring;) can lie.  Thus, 1.4 &Aring; 
  out from the molecular surface is about as close as the probe center
  can get, the <b><i>solvent-accessible</i></b> surface.
  <li><b>Color outside volume</b> 
  (for coloring by <a href="#bydata">data</a> only;
   a <a href="../../UsersGuide/coloring.html#colorwell">color well</a>) -
  color to use for vertices outside the bounds of the 
  <a href="#bydata">data</a>
  <li><b>Only color sliced surface face</b> - color only the
  <a href="../surfcapper/surfcapper.html">surface cap</a>,
  not the rest of the surface
  <li><a name="perpixel"><b>Per-pixel coloring</b></a>
  - determine color separately for each surface pixel
  instead of interpolating across surface triangles
  (see <a href="#technical">technical notes</a>).
  This tends to give smoother color gradations.  Per-pixel coloring 
  only applies to coloring by <a href="#bydata">data values</a>,
  not by gradients or <a href="#bydist">distances</a>.
  </ul>
</p>

<a name="technical">
<h4>TECHNICAL NOTES</h4></a>
<p>
<b>Per-pixel coloring</b>.
In <a href="#perpixel">per-pixel coloring</a>,
the <a href="#bydata">data</a> and the specified color/value pairs
are used to set up a 3D texture (array of colors). OpenGL 
interpolates the texture to determine a color for each surface pixel.
If it is not possible to create a 3D texture equal to the size of the
volume, per-pixel coloring will not be performed.  Some graphics 
graphics cards/drivers limit 3D texture size to 512<sup>3</sup>,
and often a smaller limit is imposed by the graphics card memory.
When per-pixel coloring is not done, the coloring is per-vertex:
data are interpolated and colors mapped as described below.
</p>
<p>
<b>Data value interpolation.</b>
The transformed coordinates of the surface and
the <a href="#bydata">data</a> are used to map 
data values to surface vertices.
<ul>
<li>For coloring by data values directly,
the value for each surface vertex is found by trilinear interpolation 
from the eight corners of the enclosing data grid cell.  
<li>For coloring by gradient norm,
the gradient at each volume grid point is
computed by taking the difference in data values between the
next and preceding grid points along each axis and dividing by twice
the grid spacing.
The gradient at a surface vertex is found by trilinear interpolation 
from the eight corners of the enclosing data grid cell.  
The norm of the interpolated gradient (the length of the gradient vector)
is used for assigning colors.
</ul>
</p><p>
<b>Color mapping</b>.
The color mapping is defined by the specified color/value pairs, or thresholds.
The value associated with each surface vertex is compared to the thresholds.  
Vertices with values lower than any threshold are assigned the 
color of the lowest-value threshold, while vertices with values higher than
any threshold are assigned the color of the highest-value threshold.  
The colors of the remaining vertices are obtained by linear 
interpolation between the nearest lower and higher thresholds.
Finally, each surface triangle is colored by linearly interpolating
its vertex colors.
Colors are defined by red, green, blue and opacity/transparency components.
</ul>
</p>

<a name="limitations">
<h4>LIMITATIONS</h4></a>
<p>
<b>Subsequent coloring may erase molecular surface custom colors</b>. 
Unless explicitly limited to non-surface items, subsequent use of
<a href="../../UsersGuide/menu.html#actcolor"><b>Actions... Color</b></a>
or the command <a href="../../UsersGuide/midas/color.html"><b>color</b></a>
on the molecule model corresponding to a
<a href="../../UsersGuide/representation.html#surfaces">molecular surface</a>
will reset the surface's color source to <b>atoms</b> and wipe out 
the <b>Surface Color</b> coloring.  The custom surface coloring
will be erased even when only parts of the molecule model 
that do not contribute to the molecular surface are recolored.
</p>
<p>
<b>Independent centers of rotation should not be used</b>. 
If the
<a href="../../UsersGuide/sideview.html#rotation">center of rotation method</a>
is set to <b>independent</b>, the relative positions of a molecular surface
and an <a href="../../UsersGuide/filetypes.html#esp">electrostatic potential</a>
map (or other
<a href="../../UsersGuide/filetypes.html#volume">volume data</a>) 
will change as rotations are performed.  Because the surface and map
motions are not properly synchronized, the resulting coloring will be wrong.
The other <a href="../../UsersGuide/sideview.html#rotation">center of 
rotation methods</a> do not cause this problem.
</p>
<hr>
<address>UCSF Computer Graphics Laboratory / August 2009</address>
</body>
</html>
